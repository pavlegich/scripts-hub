# scripts-hub
Application that provides REST API for parallel running the bash scripts.

## Функциональные требования

1. Приложение должно иметь базу данных для хранения команд.

2. API приложения должно содержать следующий функционал:

- Создание новой команды
- Получение списка команд
- Получение одной команды

3. Написать тесты.

4. Написать инструкцию по запуску программы.

Если какие-то требования не указаны, либо имеют двойное толкование, то они остаются на усмотрение соискателя. Желательно в записке к решенному заданию описать, какие вопросы возникали и какие решения были приняты.

## Необязательные требования

- Добавить в API метод для остановки команды
- Поддержка долгих команд (сохранять вывод команды в БД по мере ее выполнения, отображать вывод при получении одной команды)
- Сборка и деплой приложения. (Например: сборка deb/rpm-пакетов, Docker-образов, настроенный пайплайн в Gitlab CI, и пр.)
- Можно добавить произвольный функционал, чтобы более полно показать свои навыки, но в таком случае обязательно его задокументировать
- Принятые в ходе разработки решения описать в виде ADR

## Используемые технологии

Операционная система: MacOS или Linux (дистрибутив на выбор соискателя, указать выбранный в записке к решенному заданию)

Язык программирования: Golang

Библиотеки: Стандартную библиотеку языка можно использовать без ограничений. Сторонние можно использовать любые, но чем меньше - тем лучше.

База данных: Postgres

## Возникшие вопросы и описание решения

1. Использован линтер (golangci-lint) для анализа кода и предотвращения появления разного рода ошибок в ходе его написания. Выбран golangci-lint, так как он включает в себя сразу пакет необходимых линтеров, поддерживает удобную конфигурацию.

2. Реализована инициализация БД, использованы миграции (goose) для контроля версиями БД и сохранения консистентности при её переносе и изменении. Выбран goose, так как он не только содержит запись последней миграции, но и хранит историю каждой миграции, а также предлагает простые команды для работы с ними.

3. Использован логгер (zap) для своевременной обработки и анализа ошибок в ходе реализации приложения. Выбран zap, так как он один из лучших по времении выполнения, при этом отличается возможностью гибкой настройки.

4. Использована библиотека automaxprocs для автоматической настройки количества используемых ресурсов процессора в ходе выполнения программы.

5. Использованная ОС: MacOS.

6. Возник вопрос места на сервере для выполнения скрипта. Расположил его в хендлере, чтобы сразу проверять на корректность, после чего добавлять в базу данных.

7. Добавил проверку запросов на корректность, а также на существование запрашиваемой команды при запросе на получение команды по названию. В случае ошибки в ответе будут статус коды 400 и 404, соответственно.

8. Добавил проверку на уникальность при создании команды по ее названию. В случае ошибки в качестве ответа клиенту будет код 409.

9. Для сервиса есть два варианта запуска: локально и с помощью docker-compose. Для каждого варианта есть отдельная команда `make`.

10. Добавлены юнит-тесты для методов, в том числе с использованием моков.

11. При запросе об остановке команды, она также удаляется из БД.

12. Для хранения объектов команд и дальнейшего к ним обращения использован sync.Map для удобства конкурентного использования хранилища.

12. Возник вопрос реализации запуска и работы с длительной командой. Решил реализовать io.Writer для вывода команд, не использовать буффер в памяти, чтобы исключить его переполнение. Использовал в репозитории транзакцию для получения текущего вывода и добавления в конец нового, чтобы избежать непреднамеренного изменения данных в таблице.

13. Для выполнения команд решил использовать паттерн worker pool, чтобы контролировать количество запущенных горутин через конфигурацию приложения, а также завершать их при отмене контекста или закрытии канала.

## API

Для понимания работы с сервисом представлены:

- описание [API](https://github.com/pavlegich/scripts-hub/blob/main/api.yaml) в файле _api.yaml_;

- [примеры](https://github.com/pavlegich/scripts-hub/blob/main/scripts-hub.json) запросов в файле _scripts-hub.json_. 

## Запуск

Вывести список всех возможных команд:

`make help`

Запустить приложение локально:

`make run-local`

Запустить приложение с помощью docker-compose:

`make run-docker`

Сформировать документацию:

`make doc`

> [!NOTE]
> Изменить значения флагов:
> - для локального запуска - в первых строках Makefile;
> - для запуска с помощью docker-compose - в файле .env.

## .env Файл конфигурации

| Наименование параметра | Начальное значение | Описание |
| ---------------------- | ------------------ | -------- |
| `DB_PASSWORD` | `postgres` | Пароль для базы данных. |
| `DATABASE_DSN` | `postgresql://postgres:postgres@db:5432/postgres` | Строка подключения к базе данных. |
| `ADDRESS` | `:8080` | Адрес и порт, где будет запущено приложение. |
| `RATE_LIMIT` | `3` | Количество воркеров, работающих над запуском команд. |

## Makefile Параметры запуска

| Наименование параметра | Начальное значение | Описание |
| ---------------------- | ------------------ | -------- |
| `DATABASE_DSN` | `postgresql://localhost:5432/postgres` | Строка подключения к базе данных. |
| `RATE_LIMIT` | `3` | Количество воркеров, работающих над запуском команд. |
| `DOC_ADDR` | `localhost:6060` | Адрес и порт, где будет запущен сервис с документацией к приложению. |
| `SERVER_BINARY_NAME` | `server` | Наименование создаваемого бинарного файла для запуска приложения. |
| `SERVER_PACKAGE_PATH` | `./cmd/server` | Путь к бинарному файлу для запуска приложения. |
| `SERVER_ADDR` | `localhost:8080` | Адрес и порт, где будет запущено приложение. |
